package com.o2.o2gateway.jdbc;

import java.sql.Connection;
import java.sql.Driver;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Hashtable;
import java.util.NoSuchElementException;
import java.util.Properties;

import org.apache.log4j.Logger;

import com.o2.o2gateway.sybase.SybaseManager;

public class ConnectionManager
{
	private String driverName;
	private String dbUrl;
	private String username;
	private String password;
	private Properties props;
	private Hashtable connections;
	private static Logger log = Logger.getLogger(SybaseManager.class);

	private final int INITIAL_CONNECTIONS = 10;
	private final int ADDITIONAL_CONNECTIONS = 5;

	public ConnectionManager(
		String driverName,
		String dbUrl,
		String username,
		String password,Properties props)
		throws ClassNotFoundException, SQLException
	{
		this.driverName = driverName;
		this.dbUrl = dbUrl;
		this.username = username;
		this.password = password;
		this.props = props;
		connections = new Hashtable(INITIAL_CONNECTIONS, ADDITIONAL_CONNECTIONS);

		try
		{
			//Class.forName(driverName);
			DriverManager.registerDriver((Driver)
	                Class.forName(driverName).newInstance());
	        
	    	DriverManager.setLoginTimeout(30);
			createConnections(INITIAL_CONNECTIONS,dbUrl);
		}
		catch(ClassNotFoundException ex)
		{
			throw ex;
		}
		catch(SQLException ex)
		{
			throw ex;
		}
		catch (Exception ex) 
		{
			throw new SQLException();  
	   }
	}

	private void createConnections(int i)
		throws SQLException
	{
		int j = -1;
		j = connections.size();
		for(int k = 0; k < i; k++)
			try
			{
				Connection con=null;
				if(props != null) 
					con = DriverManager.getConnection(dbUrl, props); 
				else 
					con = DriverManager.getConnection(dbUrl, username, password); 
				if(con !=null)
						connections.put(con, new Boolean(false));
			}
			catch(SQLException sqlexception)
			{
				throw sqlexception;
			}

//		if(i > 0 && connections.size() <= j)
//		{
//			throw new SQLException("Exception creating connections. i= " + i + ", j = " + j + "connections.size() = " + connections.size());
//		}
//		else
//		{
//			return;
//		}
	}
	
	private void createConnections(int i,String ldbUrl)
	throws SQLException
	{
		int j = -1;
		j = connections.size();
		for(int k = 0; k < i; k++)
			try
		{
				Connection con=null;
				if(props != null) 
					con = DriverManager.getConnection(ldbUrl, props); 
				else 
					con = DriverManager.getConnection(ldbUrl, username, password); 
				if(con !=null)
					connections.put(con, new Boolean(false));
		}
		catch(SQLException sqlexception)
		{
			throw sqlexception;
		} 
	}
	 /**
     *  A SQLException was generated.  Catch it and
     *  display the error information.  Note that there
     *  could be multiple error objects chained
     *  together.<pollerBuf>
     *  @param ex  info will be displayed for this exception <p>
     */
    public String  displaySQLEx(SQLException ex)
    {
    	String mesg=null;
        //ex.printStackTrace();
        if (ex != null) 
        {
            mesg ="SQLState: " + ex.getSQLState () + "Message:  " + ex.getMessage () + "Vendor:   " + ex.getErrorCode () ;
            ex = ex.getNextException ();           
        }
        return mesg;
    }
	/*void closeConnections()
	throws SQLException
{
		Connection connection = null;
		java.util.Enumeration enumeration = null;

		Boolean gotConnection = null;
		if(connections == null)
		{
			return;
		}
		enumeration = connections.keys();
		synchronized(enumeration)
		{
			do
			{
				connection = (Connection)enumeration.nextElement();
				gotConnection = (Boolean)connections.get(connection);
				if(gotConnection != null)
				{
					try {
						if(!connection.isClosed())
						{
							connection.close();
							connection.clearWarnings();
						}
					} catch (SQLException e) {
						// TODO Auto-generated catch block
						String mesg = displaySQLEx(e);
						if(mesg != null)
							throw new SQLException(mesg);
						else
							throw new SQLException();
					} 
					connections.remove(connection);
				}
			} while(enumeration.hasMoreElements());
		}
}*/
	void closeConnections()
	throws SQLException
{
		Connection connection = null;
		java.util.Enumeration enumeration = null;

		Boolean gotConnection = null;
		if(connections == null)
		{
			return;
		}
		enumeration = connections.keys();
		synchronized(enumeration)
		{
			int c_cnt=0;
			while(enumeration.hasMoreElements())
			{
				connection = (Connection)enumeration.nextElement();
				synchronized(connection)
				{
					gotConnection = (Boolean)connections.get(connection);
					c_cnt++;
					if(gotConnection != null)
					{
						
						if(gotConnection.booleanValue() == true )
						{														
							log.info("[" + c_cnt + "This connection is still use");
							try {Thread.sleep(5 * 1000);} catch (InterruptedException e) {}
							if(((Boolean)connections.get(connection)).booleanValue() == true )
							{
								log.info("[" + c_cnt + "This connection is still use; removing anyway");
							}
						}
						connections.remove(connection);					 
						try {
							if(!connection.isClosed())
							{
								connection.close();
								connection.clearWarnings();
							}
						} catch (SQLException e) {
							// TODO Auto-generated catch block
							String mesg = displaySQLEx(e);
							if(mesg != null)
								throw new SQLException(mesg);
							else
								throw new SQLException();
						}						
					}
				}
			} 
		}
}
	public Connection getConnectionSingleton()
		throws SQLException
	{
		Connection connection = null;
		java.util.Enumeration enumeration = null;

		Boolean gotConnection = null;
		boolean isEmpty=false;
		if(connections == null)
		{
			return connection;
		}

		enumeration = connections.keys();
		synchronized(enumeration)
		{
			try
			{
				do
				{
					connection = (Connection)enumeration.nextElement();
					gotConnection = (Boolean)connections.get(connection);
					if(gotConnection != null && !gotConnection.booleanValue())
					{
						connections.put(connection, new Boolean(true));
					}
				} while(gotConnection != null && gotConnection.booleanValue() && enumeration.hasMoreElements());
			}
			catch(NoSuchElementException nsee)
			{
				log.debug("It seems the Connection is empty. ");
				isEmpty=true;
				/*try
				{
					createConnections(INITIAL_CONNECTIONS);
				}
				catch(SQLException sqlexception)
				{
					log.error("Trying to create a new set of connections but cannot please check previous error logs" );
					throw sqlexception;
				}
				finally
				{
					return null;
				}*/
			}
		}
		if(gotConnection != null && gotConnection.booleanValue() || isEmpty)
		{
			try
			{
				synchronized(connections)
				{
					if(connections.size() == 0)
						createConnections(INITIAL_CONNECTIONS);
					else
						createConnections(ADDITIONAL_CONNECTIONS);
				}
			}
			catch(SQLException sqlexception)
			{
				throw sqlexception;
			}
			finally
			{
				return null;
			}
		}
		else
		{
			try
			{
				if(connection.isClosed())
				{
					connections.remove(connection);
					connection = null;
					createConnections(1);
				} else
				{
					Statement statement = connection.createStatement();
					ResultSet resultset = statement.executeQuery("show props");
					resultset.close();
					statement.close();
					statement = null;
					resultset = null;
				}
			}
			catch(SQLException sqlexception1)
			{
				connections.remove(connection);
				connection = null;
				createConnections(1);
			}
			finally
			{
				return connection;
			}
		}
	}

	public void returnConnectionSingleton(Connection connection)
	{
		synchronized(connections)
		{
			connections.put(connection, new Boolean(false));
		}
	}

	/**
	 * @param dbUrl the dbUrl to set
	 */
	public void setDbUrl(String dbUrl) {
		this.dbUrl = dbUrl;
	}	
}
